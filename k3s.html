<!DOCTYPE html>
<html>
<head>
<link rel="Stylesheet" type="text/css" href="style.css">
<title>k3s</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<div id="K3S"><h1 id="K3S" class="header"><a href="#K3S">K3S</a></h1></div>

<p>
安装参考：<a href="https://docs.rancher.cn/docs/k3s/quick-start/_index">https://docs.rancher.cn/docs/k3s/quick-start/_index</a>
</p>

<pre sh>
curl -L http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh &gt;k3s.sh
INSTALL_K3S_MIRROR=cn sh k3s.sh --cluster-domain c.c
</pre>

<p>
上面强行借用了 <code>c.c</code> 作为域名，之后访问服务就可以使用 <code>&lt;foobar&gt;.&lt;namespace&gt;.svc.c.c</code> 的方式。之前想用 <code>cc</code>，但是发现影响 <code>*.cc</code> 的解析，作罢。
</p>

<p>
(当然也可以直接用 <code>c</code>，以下的 <code>c.c</code> 皆可替换为 <code>c</code>)
</p>

<p>
最好是通过路由配置，直接接入 k3s 的网络，<code>10.42.0.0/15 (10.42.0.0-10.43.255.255)</code>：
</p>

<pre sh>
ip route add 10.42.0.0/15 via 10.0.0.123
</pre>

<p>
然后把 DNS 也设置成 <code>10.43.0.10</code>，
或者把它作为 <code>*.c.c</code> 的上游，比如 openwrt dnsmasq 可以编辑 <code>/etc/dnsmasq.conf</code>, 加一行：<code>server=/c.c/10.43.0.10</code> 。
</p>

<p>
版本迭代很快啊，经过测试，v1.21.x 有问题，回退到 v1.19.x 就好了，自己去 github 下载 k3s 二进制 到 /usr/local/bin/ , 然后：
</p>

<pre sh>
INSTALL_K3S_SKIP_DOWNLOAD=true INSTALL_K3S_MIRROR=cn sh k3s.sh --cluster-domain c.c                                                                                                                              
</pre>

<p>
注意，<code>ulimit -n</code> 要给够，系统默认 1024 不行，要改。
</p>

<p>
可以自己手动启动：<code>k3s server --cluster-domain c.c</code>。
</p>

<div id="K3S-docker image mirror"><h3 id="docker image mirror" class="header"><a href="#K3S-docker image mirror">docker image mirror</a></h3></div>

<p>
官方的仓库可能比较慢，建议使用镜像。编辑 <code>/etc/rancher/k3s/registries.yaml</code>:
</p>

<pre yaml>
mirrors:
  docker.io:
    endpoint:
    - https://hub-mirror.c.163.com
    - https://ustc-edu-cn.mirror.aliyuncs.com
</pre>

<p>
重启：<code>systemctl restart k3s</code> or <code>systemctl restart k3s-agent</code>，看效果：<code>crictl info | jq .config.registry.mirrors</code>。
</p>

<p>
参考：
</p>
<ul>
<li>
<a href="https://rancher.com/docs/k3s/latest/en/installation/private-registry/#mirrors">https://rancher.com/docs/k3s/latest/en/installation/private-registry/#mirrors</a>

<li>
<a href="https://yeasy.gitbook.io/docker_practice/install/mirror">https://yeasy.gitbook.io/docker_practice/install/mirror</a>

</ul>

</body>
</html>
