<!DOCTYPE html>
<html>
<head>
<link rel="Stylesheet" type="text/css" href="style.css">
<title>docker</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>

<div id="Docker"><h1 id="Docker">Docker</h1></div>

<p>
<a href="https://hub.docker.com/">https://hub.docker.com/</a>
</p>

<p>
入门教程 <a href="https://docker_practice.gitee.io/">https://docker_practice.gitee.io/</a>
</p>

<p>
与 <code>CoreOS</code> 搭配更佳。如果需要升级，使用：
</p>

<pre sh>
update_engine_client -update
</pre>

<p>
然后重启完成升级。
</p>

<p>
CoreOS 需要 SELINUX，不然会有奇怪的错误。
</p>
<pre sh>
vi /etc/selinux/config 

SELINUX=enforcing
</pre>


<div id="Docker-常用工具"><h3 id="常用工具">常用工具</h3></div>

<ul>
<li>
portainer <a href="https://www.portainer.io/installation/">https://www.portainer.io/installation/</a>

<li>
ctop <a href="https://github.com/bcicen/ctop">https://github.com/bcicen/ctop</a>

</ul>

<div id="Docker-基础镜像"><h3 id="基础镜像">基础镜像</h3></div>

<ul>
<li>
alpine

<li>
debian:buster-slim

<li>
debian:stretch-slim

</ul>

<div id="Docker-常用容器"><h3 id="常用容器">常用容器</h3></div>

<p>
portainer:
</p>

<pre sh>
docker volume create portainer_data
docker run -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer
</pre>

<p>
htop:
</p>

<pre sh>
docker run -it --name=htop --pid=host jonbaldie/htop
docker run -it --rm --pid=container:XXX jonbaldie/htop
</pre>

<p>
ctop:
</p>

<pre sh>
docker run -it -v /var/run/docker.sock:/var/run/docker.sock:ro quay.io/vektorlab/ctop
</pre>

<p>
nginx:
</p>

<pre sh>
docker volume create www
docker run -p 8080:80 -v www:/usr/share/nginx/html:ro -d nginx:alpine
</pre>

<p>
gogs:
</p>

<pre sh>
docker pull gogs/gogs:0.11.86
docker volume create gogs
docker run -p 22:22 -p 3000:3000 gogs/gogs:0.11.86
</pre>

<p>
/dev/mqueue:
</p>

<pre sh>
docker run -it --ipc=host alpine sh

docker run -it --name=main alpine sh
docker run -it --ipc=container:main alpine sh
</pre>

<div id="Docker-alpine gcc"><h3 id="alpine gcc">alpine gcc</h3></div>

<pre sh>
sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories
apk add --no-cache gcc musl-dev
</pre>

<div id="Docker-/opt/bin"><h3 id="/opt/bin">/opt/bin</h3></div>

<p>
可以把 docker 容器启动的工具放这里，如 <code>htop</code>, <code>ctop</code>
</p>

<pre sh>
docker start -ia $(basename $0)
</pre>


<div id="Docker-Dockerfile for Python"><h3 id="Dockerfile for Python">Dockerfile for Python</h3></div>

<pre Dockerfile>
FROM python:stretch as base

RUN apt-get update
RUN apt-get install -y libev-dev \
    &amp;&amp; pip install -i https://pypi.douban.com/simple --user \
        gunicorn falcon pycrypto pyyaml requests redis pymysql pony

FROM python:slim-stretch
COPY --from=base /root/.local /root/.local
ENV PATH /root/.local/bin:${PATH}

WORKDIR /root/
EXPOSE 8000

COPY .gunicorn cfg.yaml *.py ./

CMD [ "gunicorn", "-c", ".gunicorn", "xxx" ]
</pre>

<p>
还有一种方法生成的镜像更小，<code>pyinstaller</code> 打包结果 + <code>debian:stretch-slim</code>，浅尝可用。
理论上可以用 pyinstaller on alpine，但是安装时失败，算了。
</p>

<pre sh>
pyinstaller your-script.py
# or
PYTHONOPTIMIZE=2 pyinstaller -y -s your-script.py
</pre>

<p>
生成的文件有部分不是必须的，如
</p>
<ul>
<li>
<code>*lzma*</code>

<li>
<code>*readline*</code>

<li>
<code>libcrypto.so.*</code>

</ul>
<p>
视情况和心情剔除。
</p>

<p>
剩下的举例：
</p>
<pre sh>
_bisect.cpython-37m-x86_64-linux-gnu.so
_blake2.cpython-37m-x86_64-linux-gnu.so
_heapq.cpython-37m-x86_64-linux-gnu.so
_md5.cpython-37m-x86_64-linux-gnu.so
_pickle.cpython-37m-x86_64-linux-gnu.so
_queue.cpython-37m-x86_64-linux-gnu.so
_random.cpython-37m-x86_64-linux-gnu.so
_sha1.cpython-37m-x86_64-linux-gnu.so
_sha256.cpython-37m-x86_64-linux-gnu.so
_sha3.cpython-37m-x86_64-linux-gnu.so
_sha512.cpython-37m-x86_64-linux-gnu.so
_struct
_struct.cpython-37m-x86_64-linux-gnu.so
base_library.zip
libpython3.7m.so
libz.so.1
math.cpython-37m-x86_64-linux-gnu.so
posix_ipc.cpython-37m-x86_64-linux-gnu.so
ts
zlib
zlib.cpython-37m-x86_64-linux-gnu.so
</pre>

<p>
极限控制镜像包大小，先用 <code>pyinstaller</code> 打包，然后从 <code>debian:stretch-slim</code> 拷贝出 <code>lib</code> <code>lib64</code>，和 <code>pyinstaller</code> 打包出的文件夹一起打一个 <code>tgz</code>：
</p>

<pre sh>
tar czf XXX.tgz lib* XXX
</pre>

<p>
如何极限精简打包，参考 <a href="https://gist.github.com/lwzm/f3dfb447f7927b78d70c040aa1c3a5e1">https://gist.github.com/lwzm/f3dfb447f7927b78d70c040aa1c3a5e1</a>
</p>

<p>
最后：
</p>

<pre Dockerfile>
FROM debian:stretch-slim as base
RUN mkdir /x &amp;&amp; cp -a /lib* /tmp /x
FROM scratch
COPY --from=base /x /
COPY /t /app
CMD /app/t
</pre>

<p>
上述方法打出来的镜像，可比肩 Golang，但是对代码质量和系统细节的掌控的要求比较高。
</p>

<div id="Docker-docker compose"><h3 id="docker compose">docker compose</h3></div>

<p>
把 nginx 和其它几个 web 服务放一起，例子：
</p>

<pre yaml>
version: '3'
services:

  nginx:
    image: nginx:alpine
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro
      - ./log:/var/log
      - ./nginx-conf.d:/etc/nginx/conf.d
    ports: 
      - "80:80"
      - "443:443"
    depends_on:
      - portainer
      - gogs
      - filebrowser
      - rancher

  portainer:
    image: portainer/portainer
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./portainer:/data

  gogs:
    image: gogs/gogs:0.11.86
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./gogs:/data
    ports: 
      - "22:22"

  filebrowser:
    image: filebrowser/filebrowser
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./filebrowser/srv:/srv
      - ./filebrowser/database.db:/database.db

  rancher:
    image: rancher/rancher:stable
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./rancher:/var/lib/rancher
</pre>


<p>
附 nginx 相关配置：
</p>

<pre conf>
upstream gogs {
    server gogs:3000;
    keepalive 64;
}

server {
    server_name  git.* gogs.*;
    #listen       80;
    listen       443 ssl http2;

    location / {
        proxy_pass http://gogs;
    }
}
</pre>

<pre conf>
upstream portainer {
    server portainer:9000;
    keepalive 64;
}

server {
    server_name  portainer.*;
    #listen       80;
    listen       443 ssl http2;

    # for websocket, do not ignore any line
    proxy_http_version 1.1;
    proxy_connect_timeout 2;
    proxy_read_timeout 300;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Connection "upgrade";
    proxy_set_header Upgrade $http_upgrade;

    location / {
        proxy_pass http://portainer;
    }
}
</pre>

</body>
</html>
